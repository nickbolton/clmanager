package net.deuce.clmanager.gwt.main.client;

import net.mygwt.ui.client.Registry;
import net.mygwt.ui.client.Style;
import net.mygwt.ui.client.event.BaseEvent;
import net.mygwt.ui.client.event.SelectionListener;
import net.mygwt.ui.client.mvc.AppEvent;
import net.mygwt.ui.client.mvc.Controller;
import net.mygwt.ui.client.util.Format;
import net.mygwt.ui.client.widget.ToolBar;
import net.mygwt.ui.client.widget.ToolItem;
import net.mygwt.ui.client.widget.WidgetContainer;
import net.mygwt.ui.client.widget.layout.FillLayout;

import com.google.gwt.user.client.ui.DockPanel;
import com.google.gwt.user.client.ui.HTML;
import com.google.gwt.user.client.ui.VerticalPanel;

public class PostView extends ReplyView {

    private VerticalPanel wrapper;
    private VerticalPanel headerPanel;
    private WidgetContainer bodyWrapper;
    private ToolBar toolBar;
    private HTML header;
    private HTML body;
    private PostModel post;
    
    private String headerHTML =
        "<div class=post-detail><p><b>City:</b> {0} <b>Category:</b> {1}</p><p><b>Date:</b> {2}/{3} <b>Age:</b> {4}</p><p><b>Title:</b> {5}</p></div>";

    public PostView(Controller controller) {
        super(controller);
    }
    
        
    protected void initialize() {
        wrapper = new VerticalPanel();
        
        body = new HTML();
        body.setWordWrap(true);
        bodyWrapper = new WidgetContainer();
        bodyWrapper.setLayout(new FillLayout());
        bodyWrapper.add(body);
        
        DockPanel innerPanel = new DockPanel();
        headerPanel = new VerticalPanel();
        headerPanel.setWidth("100%");
        innerPanel.add(headerPanel, DockPanel.NORTH);
        innerPanel.add(bodyWrapper, DockPanel.CENTER);
        innerPanel.setCellHeight(bodyWrapper, "100%");
        innerPanel.setSize("100%", "100%");
        wrapper.add(innerPanel);
        
        toolBar = new ToolBar();
        
        headerPanel.add(toolBar);
        
        ToolItem flagItem = new ToolItem(Style.PUSH);
        flagItem.setText("Flag");
        flagItem.setBorders(true);
        flagItem.addSelectionListener(new SelectionListener() {
            public void widgetSelected(BaseEvent be) {
                flag(post);
            }
        });
        toolBar.add(flagItem);
        
        //ToolItemAdapter messageTemplateAdapter = new ToolItemAdapter(getMessageTemplates());
        //toolBar.add(messageTemplateAdapter);
        
        ToolItem replyItem = new ToolItem(Style.PUSH);
        replyItem.setText("Reply");
        replyItem.setBorders(true);
        replyItem.addSelectionListener(new SelectionListener() {
            public void widgetSelected(BaseEvent be) {
                setupReply(post);
            }
        });
        toolBar.add(replyItem);
        
        ToolItem editReplyItem = new ToolItem(Style.PUSH);
        editReplyItem.setText("Edit/Reply");
        editReplyItem.setBorders(true);
        editReplyItem.addSelectionListener(new SelectionListener() {
            public void widgetSelected(BaseEvent be) {
                setupEditReply(post);
            }
        });
        toolBar.add(editReplyItem);
        
        ToolItem newReplyItem = new ToolItem(Style.PUSH);
        newReplyItem.setText("New Reply");
        newReplyItem.setBorders(true);
        newReplyItem.addSelectionListener(new SelectionListener() {
            public void widgetSelected(BaseEvent be) {
                setupNewReply(post);
            }
        });
        toolBar.add(newReplyItem);
        
        header = new HTML("");
        headerPanel.add(header);
    }
    
    
    protected void handleEvent(AppEvent event) {
        switch (event.type) {
        case AppEvents.ViewPost:
            post = (PostModel) event.data;
            WidgetContainer south = (WidgetContainer) Registry.get("south");

            south.removeAll();
            if (post != null) {
                String[] values = {
                    post.getCity(),
                    post.getCategory(),
                    Integer.toString(post.getDate().getMonth()+1),
                    Integer.toString(post.getDate().getDate()),
                    post.getAge(),
                    post.getTitle(),
                };
                String s = Format.substitute(headerHTML, values);
                header.setHTML(s);
                
                s = "<div style='padding: 12px; font-size: 14px; word-wrap: break-word'><pre>"
                    + post.getContent().trim() + "</pre></div>";
                body.setHTML(s);

                south.add(wrapper);
                south.layout(true);

            }
            break;
        case AppEvents.RefreshMessageTemplates:
            refreshMessageTemplates();
            break;
        }
    }
}
